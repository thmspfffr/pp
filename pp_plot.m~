%%

clear
restoredefaultpath

addpath ~/Documents/MATLAB/fieldtrip-20160919/
addpath ~/pconn/matlab/
load(sprintf('~/pp/proc/pp_atlas_BNA.mat'))
load /home/gnolte/meth/templates/mri.mat

ft_defaults

outdir = '~/pp/proc/src/';
ord    = pconn_randomization;
load ~/standard_sourcemodel_BNA_5mm.mat

trans = pp_transfer_gla2hh;
%% LOAD GLASGOW DATA


load(['/home/tpfeffer/pconn/proc/preproc/' 'pp_ft_freqstruc' '.mat'])
addpath ~/Documents/MATLAB/Colormaps/'Colormaps (5)'/Colormaps/
addpath ~/Documents/MATLAB/cbrewer/cbrewer/
cmap = cbrewer('div', 'RdBu', 256,'pchip'); cmap = cmap(end:-1:1,:);

clear all_ck_pow all_tp_pow all_sens

all_pow = nan(248,25,24,1);

v=3;
SUBJ = 1:24; SUBJ([5 9])=[];

for n_subj = 1: length(SUBJ)
  isubj = SUBJ(n_subj);
  for iblock = 1 : 1
    clear src_r
    try
      load(sprintf([outdir 'pp_gla_src_pupil_power_correlations_s%d_b%d_v%d.mat'],isubj,iblock,v));
      
      plt_gla.pow_sens(:,:,n_subj) = outp.tp_sens_pow;
      plt_gla.corr_sens(:,:,n_subj) = outp.sens_r;
      plt_gla.corr_src(:,:,n_subj) = outp.tp_src_r(trans,:);
      plt_gla.nai_src(:,:,n_subj) = outp.tp_src_nai(trans,:);
    catch me
      plt_gla.pow_sens(:,:,n_subj) = nan(248,25);
      plt_gla.corr_sens(:,:,n_subj)= nan(248,25);
      plt_gla.corr_src(:,:,n_subj) = nan(8799,25);
      plt_gla.nai_src(:,:,n_subj) = nan(8799,25);
      
      warning('!')
    end
  end
end
% 
for igrid = 1 : max(BNA.tissue_5mm(:))
  plt_gla.corr_src_BNA(igrid,:,:) = tanh(mean(atanh(plt_gla.corr_src(BNA.tissue_5mm == igrid,:,:))));
end

plt_hh.pow_sens = nan(274,25,28,2);
plt_hh.corr_sens = nan(274,25,28,2);

SUBJLIST = [4 5 6 7 8 9 10 11 12 13 15 16 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34];
for isubj = SUBJLIST
  isubj
  for iblock = 1 : 2
    clear src_r
    try
      load(sprintf([outdir 'pp_src_pupil_power_correlations_s%d_b%d_v%d.mat'],isubj,iblock,v));
      load(sprintf('~/pconn/proc/preproc/pconn_chanidx_s%d_m%d.mat',isubj,find(ord(isubj,:)==1)))
      idx=logical(idx);
      isubj
      plt_hh.pow_sens(idx,:,isubj,iblock) = outp.tp_sens_pow;
      plt_hh.corr_sens(idx,:,isubj,iblock) = outp.sens_r;
      plt_hh.corr_src(:,:,isubj,iblock) = outp.src_r;
      plt_hh.nai_src(:,:,isubj,iblock) = outp.src_nai;
    catch me
      warning('!!!')
      plt_hh.pow_sens(idx,:,isubj,iblock) = nan(sum(idx),25,1,1);
      plt_hh.corr_sens(idx,:,isubj,iblock) = nan(sum(idx),25,1,1);
      plt_hh.corr_src(:,:,isubj,iblock) = nan(8799,25);
      plt_hh.nai_src(:,:,isubj,iblock) = nan(8799,25);
      continue
    end
  end
end

addpath ~/Documents/MATLAB/Colormaps/'Colormaps (5)'/Colormaps/
addpath ~/Documents/MATLAB/cbrewer/cbrewer/
cmap = cbrewer('div', 'RdBu', 256,'pchip'); cmap = cmap(end:-1:1,:);


plt_hh.corr_sens = nanmean(plt_hh.corr_sens(:,:,SUBJLIST,:),4);
plt_hh.corr_src = nanmean(plt_hh.corr_src(:,:,SUBJLIST,:),4);
plt_hh.nai_src = nanmean(plt_hh.nai_src(:,:,SUBJLIST,:),4);
plt_hh.pow_sens = nanmean(plt_hh.pow_sens(:,:,SUBJLIST,:),4);

% 
for igrid = 1 : max(BNA.tissue_5mm(:))
  plt_hh.corr_src_BNA(igrid,:,:) = tanh(mean(atanh(plt_hh.corr_src(BNA.tissue_5mm == igrid,:,:))));
end

% COLLAPSE ACROSS DATASETS
plt_all.corr_src = cat(3,plt_hh.corr_src,plt_gla.corr_src);
plt_all.nai_src = cat(3,plt_hh.nai_src,plt_gla.nai_src);


cfg=[];
cfg.layout='4D248.lay';
lay = ft_prepare_layout(cfg);
minmax_gla=[min(lay.pos(:,2)) max(lay.pos(:,2))];
ser_gla = linspace(minmax_gla(1),minmax_gla(2),40);
plt_gla.corr_sens_ord= zeros(size(ser_gla,2)-1,25,22);

for i = 1 : size(ser_gla,2)-1
  idx = lay.pos(:,2)<ser_gla(i+1) & lay.pos(:,2)>ser_gla(i);
  plt_gla.corr_sens_ord(i,:,:) = nanmean(plt_gla.corr_sens(idx,:,:),1);
end

cfg=[];
cfg.layout='CTF275.lay';
lay = ft_prepare_layout(cfg);
lay.pos([203 276 277],:)=[];
minmax_hh=[min(lay.pos(:,2)) max(lay.pos(:,2))];
ser_hh = linspace(minmax_gla(1),minmax_hh(2),40);
plt_hh.corr_sens_ord= zeros(size(ser_hh,2)-1,25,28);

for i = 1 : size(ser_gla,2)-1
  idx = lay.pos(:,2)<ser_hh(i+1) & lay.pos(:,2)>ser_hh(i);
  plt_hh.corr_sens_ord(i,:,:) = nanmean(plt_hh.corr_sens(idx,:,:),1);
end

%% PLOT CORRELATION IN SENSOR SPACE - SORTED FROM ANTERIOR TO POSTERIOR
freqoi=2.^(1:(1/4):7); 

figure_w

subplot(2,3,1);
imagesc(nanmean(plt_gla.corr_sens_ord,3),[-0.03 0.03])
colormap(cmap); tp_editplots; axis square
set(gca,'ydir','normal','xtick',1:4:25,'xticklabel',round(freqoi(1:4:25)))
xlabel('Frequency [Hz]')

subplot(2,3,2);
imagesc(nanmean(plt_hh.corr_sens_ord,3),[-0.03 0.03])
colormap(cmap); tp_editplots; axis square
set(gca,'ydir','normal','xtick',1:4:25,'xticklabel',round(freqoi(1:4:25)))
xlabel('Frequency [Hz]')

pooled = cat(3,plt_hh.corr_sens_ord,plt_gla.corr_sens_ord);

subplot(2,3,3);
imagesc(nanmean(pooled,3),[-0.03 0.03])
colormap(cmap); tp_editplots; axis square;
set(gca,'ydir','normal','xtick',1:4:25,'xticklabel',round(freqoi(1:4:25)))
xlabel('Frequency [Hz]')

print(gcf,'-dpdf',sprintf('~/pp/plots/pp_sens_anterior_post_v%d.pdf',v))

%% PLOT AVERAGES ACROSS SPACE, HAMBURG, GLASGOW, ALL

% -----------------
% SENSOR SPACE - POWER
% -----------------
freqoi=2.^(1:(1/4):7); 


par_gla = mean(log10(nanmean(plt_gla.pow_sens,1)),3);
par_hh = mean(log10(plt_hh.pow_sens),2);
std_gla = std(log10(nanmean(plt_gla.pow_sens,1)),[],3)/sqrt(size(plt_gla.pow_sens,3));
std_hh = std(log10(plt_hh.pow_sens),[],2)/sqrt(size(plt_hh.pow_sens,2));

par_all = mean(cat(2,log10(squeeze(nanmean(plt_gla.pow_sens,1))),log10(plt_hh.pow_sens)),2);
std_all = std(cat(2,log10(squeeze(nanmean(plt_gla.pow_sens,1))),log10(plt_hh.pow_sens)),[],2)/sqrt(size(plt_hh.pow_sens,2));

figure_w
subplot(4,3,1)
shadedErrorBar(log10(freqoi),par_gla,std_gla,'b')
axis([.3 2.11 -24 -21])
% line([.3 2.11], [0 0],'color',[.7 .7 .7],'linestyle',':')
tp_editplots; xlabel('Frequency [Hz]');ylabel('Log-Power')
set(gca,'xtick',log10(freqoi(1:4:25)),'xticklabel',round(freqoi(1:4:25)))

subplot(4,3,2)
shadedErrorBar(log10(freqoi),par_hh,std_hh,'r')
axis([.3 2.11 -24 -21])
line([.3 2.11], [0 0],'color',[.7 .7 .7],'linestyle',':')
tp_editplots; xlabel('Frequency [Hz]');ylabel('Log-Power')
set(gca,'xtick',log10(freqoi(1:4:25)),'xticklabel',round(freqoi(1:4:25)))

subplot(4,3,3)
shadedErrorBar(log10(freqoi),par_all,std_all,'k')
axis([.3 2.11 -24 -21])
line([.3 2.11], [0 0],'color',[.7 .7 .7],'linestyle',':')
tp_editplots; xlabel('Frequency [Hz]');ylabel('Log-Power')
set(gca,'xtick',log10(freqoi(1:4:25)),'xticklabel',round(freqoi(1:4:25)))


% -----------------
% SENSOR SPACE - CORRELATIONS
% -----------------
par_gla = mean(nanmean(plt_gla.corr_sens,1),3);
par_hh = mean(plt_hh.corr_sens,2);
std_gla = std(nanmean(plt_gla.corr_sens,1),[],3)/sqrt(size(plt_gla.corr_sens,3));
std_hh = std(plt_hh.corr_sens,[],2)/sqrt(size(plt_hh.corr_sens,2));

par_all = mean(cat(2,squeeze(nanmean(plt_gla.corr_sens,1)),plt_hh.corr_sens),2);
std_all = std(cat(2,squeeze(nanmean(plt_gla.corr_sens,1)),plt_hh.corr_sens),[],2)/sqrt(50);



subplot(4,3,7)
shadedErrorBar(log10(freqoi),par_gla,std_gla,'b')
axis([.3 2.11 -0.05 0.05])
line([.3 2.11], [0 0],'color',[.7 .7 .7],'linestyle',':')
tp_editplots; xlabel('Frequency [Hz]');ylabel('Mean corr.')
set(gca,'xtick',log10(freqoi(1:4:25)),'xticklabel',round(freqoi(1:4:25)))

subplot(4,3,8)
shadedErrorBar(log10(freqoi),par_hh,std_hh,'r')
axis([.3 2.11 -0.05 0.05])
line([.3 2.11], [0 0],'color',[.7 .7 .7],'linestyle',':')
tp_editplots; xlabel('Frequency [Hz]');ylabel('Mean corr.')
set(gca,'xtick',log10(freqoi(1:4:25)),'xticklabel',round(freqoi(1:4:25)))

subplot(4,3,9)
shadedErrorBar(log10(freqoi),par_all,std_all,'k')
axis([.3 2.11 -0.05 0.05])
line([.3 2.11], [0 0],'color',[.7 .7 .7],'linestyle',':')
tp_editplots; xlabel('Frequency [Hz]');ylabel('Mean corr.')
set(gca,'xtick',log10(freqoi(1:4:25)),'xticklabel',round(freqoi(1:4:25)))

% -----------------
% SOURCE SPACE
% -----------------
par_gla = mean(nanmean(plt_gla.corr_src,1),3);
par_hh = mean(mean(plt_hh.corr_src,1),3);
std_gla = std(nanmean(plt_gla.corr_src,1),[],3)/sqrt(size(plt_gla.corr_src,3));
std_hh = std(nanmean(plt_hh.corr_src,1),[],3)/sqrt(size(plt_hh.corr_src,2));

par_all = nanmean(mean(cat(3,plt_gla.corr_src,plt_hh.corr_src),1),3);
std_all = std(nanmean(cat(3,plt_gla.corr_src,plt_hh.corr_src),1),[],3)/sqrt(50);


subplot(4,3,10)
shadedErrorBar(log10(freqoi),par_gla,std_gla,'b')
axis([.3 2.11 -0.05 0.05])
line([.3 2.11], [0 0],'color',[.7 .7 .7],'linestyle',':')
tp_editplots; xlabel('Frequency [Hz]');ylabel('Mean corr.')
set(gca,'xtick',log10(freqoi(1:4:25)),'xticklabel',round(freqoi(1:4:25)))


subplot(4,3,11)
shadedErrorBar(log10(freqoi),par_hh,std_hh,'r')
axis([.3 2.11 -0.05 0.05])
line([.3 2.11], [0 0],'color',[.7 .7 .7],'linestyle',':')
tp_editplots; xlabel('Frequency [Hz]');ylabel('Mean corr.')
set(gca,'xtick',log10(freqoi(1:4:25)),'xticklabel',round(freqoi(1:4:25)))

subplot(4,3,12)
shadedErrorBar(log10(freqoi),par_all,std_all,'k')
axis([.3 2.11 -0.05 0.05])
line([.3 2.11], [0 0],'color',[.7 .7 .7],'linestyle',':')
tp_editplots; xlabel('Frequency [Hz]');ylabel('Mean corr.')
set(gca,'xtick',log10(freqoi(1:4:25)),'xticklabel',round(freqoi(1:4:25)))

print(gcf,'-dpdf',sprintf('~/pp/plots/pp_sens_lineplots_v%d.pdf',v))

%% PLOT SOURCE SPACE - FROM ANTERIOR TO POSTERIOR
figure_w
subplot(2,3,1)
[h,p]=ttest(plt_gla.corr_src_BNA,zeros(size(plt_gla.corr_src_BNA)),'dim',3); 
imagesc(nanmean(plt_gla.corr_src_BNA,3).*h,[-0.05 0.05])
tp_editplots; colormap(cmap)
set(gca,'xtick',1:4:25,'xticklabel',round(freqoi(1:4:25)))
xlabel('Frequency [Hz]'); ylabel('Brain region')

subplot(2,3,2)
[h,p]=ttest(plt_hh.corr_src_BNA,zeros(size(plt_hh.corr_src_BNA)),'dim',3); 
imagesc(nanmean(plt_hh.corr_src_BNA,3).*h,[-0.05 0.05])
tp_editplots; colormap(cmap)
set(gca,'xtick',1:4:25,'xticklabel',round(freqoi(1:4:25)))
xlabel('Frequency [Hz]'); ylabel('Brain region')

subplot(2,3,3)

pooled= cat(3,plt_hh.corr_src_BNA,plt_gla.corr_src_BNA); 
[~,p]=ttest(pooled,zeros(size(pooled)),'dim',3); h = p<fdr1(p(:),0.05,0);
imagesc(nanmean(pooled,3).*h,[-0.05 0.05])
tp_editplots; colormap(cmap)
set(gca,'xtick',1:4:25,'xticklabel',round(freqoi(1:4:25)))
xlabel('Frequency [Hz]'); ylabel('Brain region')

print(gcf,'-dpdf',sprintf('~/pp/plots/pp_src_correlations_BNA_v%d.pdf',v))

%% PLOT REGIONS OF INTEREST, SENSORY AREAS

M1 = [-42 -26 54; 38 -32 48];
V1 = [-20 -86 18; 16 -80 26];
A1 = [-54 -22 10; 52 -24 12];

for i= 1 : size(BNA.grid_5mm,1)
  
  d_A1_l(i) = sqrt((BNA.grid_5mm(i,1)-A1(1,1))^2 + (BNA.grid_5mm(i,2)-A1(1,2))^2 + (BNA.grid_5mm(i,3)-A1(1,3))^2);
  d_A1_r(i) = sqrt((BNA.grid_5mm(i,1)-A1(2,1))^2 + (BNA.grid_5mm(i,2)-A1(2,2))^2 + (BNA.grid_5mm(i,3)-A1(2,3))^2);
  d_V1_l(i) = sqrt((BNA.grid_5mm(i,1)-V1(1,1))^2 + (BNA.grid_5mm(i,2)-V1(1,2))^2 + (BNA.grid_5mm(i,3)-V1(1,3))^2);
  d_V1_r(i) = sqrt((BNA.grid_5mm(i,1)-V1(2,1))^2 + (BNA.grid_5mm(i,2)-V1(2,2))^2 + (BNA.grid_5mm(i,3)-V1(2,3))^2);
  d_M1_l(i) = sqrt((BNA.grid_5mm(i,1)-M1(1,1))^2 + (BNA.grid_5mm(i,2)-M1(1,2))^2 + (BNA.grid_5mm(i,3)-M1(1,3))^2);
  d_M1_r(i) = sqrt((BNA.grid_5mm(i,1)-M1(2,1))^2 + (BNA.grid_5mm(i,2)-M1(2,2))^2 + (BNA.grid_5mm(i,3)-M1(2,3))^2);
  
end
[~,A1_l]=min(d_A1_l);
[~,A1_r]=min(d_A1_r);
[~,V1_l]=min(d_V1_l);
[~,V1_r]=min(d_V1_r);
[~,M1_l]=min(d_M1_l);
[~,M1_r]=min(d_M1_r);

figure_w;
subplot(4,3,1); hold on
r_A1_lr = corr(nanmean(plt_all.corr_src(A1_l,:,:),3)',nanmean(plt_all.corr_src(A1_r,:,:),3)');
sig_A1_lr = mean(plt_all.corr_src([A1_l A1_r],:,:),1);
[~,p]=ttest(sig_A1_lr,zeros(size(sig_A1_lr)),'dim',3); h=(p*25)<0.05;
shadedErrorBar(log10(freqoi),nanmean(sig_A1_lr,3),std(sig_A1_lr,[],3)/sqrt(size(sig_A1_lr,3)),'k')
plot(log10(freqoi(h)),nanmean(sig_A1_lr(:,h,:),3),'k.','markersize',8)
line([.3 2.11], [0 0],'color',[.7 .7 .7],'linestyle',':')
tp_editplots; xlabel('Frequency [Hz]');ylabel('Mean corr.')
set(gca,'xtick',log10(freqoi(1:4:25)),'xticklabel',round(freqoi(1:4:25)))
axis([.3 2.11 -0.05 0.05]); title(sprintf('A1: r = %.3f',r_A1_lr))

subplot(4,3,2); hold on
r_V1_lr = corr(nanmean(plt_all.corr_src(V1_l,:,:),3)',nanmean(plt_all.corr_src(V1_r,:,:),3)');
sig_V1_lr = mean(plt_all.corr_src([V1_l V1_r],:,:),1);
[~,p]=ttest(sig_V1_lr,zeros(size(sig_V1_lr)),'dim',3); h=(p*25)<0.05;
shadedErrorBar(log10(freqoi),nanmean(sig_V1_lr,3),std(sig_V1_lr,[],3)/sqrt(size(sig_V1_lr,3)),'k')
plot(log10(freqoi(h)),nanmean(sig_V1_lr(:,h,:),3),'k.','markersize',8)
line([.3 2.11], [0 0],'color',[.7 .7 .7],'linestyle',':')
tp_editplots; xlabel('Frequency [Hz]');ylabel('Mean corr.')
set(gca,'xtick',log10(freqoi(1:4:25)),'xticklabel',round(freqoi(1:4:25)))
axis([.3 2.11 -0.05 0.05]); title(sprintf('V1: r = %.3f',r_V1_lr))

subplot(4,3,3); hold on
r_M1_lr = corr(nanmean(plt_all.corr_src(M1_l,:,:),3)',nanmean(plt_all.corr_src(M1_r,:,:),3)');
sig_M1_lr = mean(plt_all.corr_src([M1_l M1_r],:,:),1);
[~,p]=ttest(sig_M1_lr,zeros(size(sig_M1_lr)),'dim',3); h=(p*25)<0.05;
shadedErrorBar(log10(freqoi),nanmean(sig_M1_lr,3),std(sig_M1_lr,[],3)/sqrt(size(sig_M1_lr,3)),'k')
plot(log10(freqoi(h)),nanmean(sig_M1_lr(:,h,:),3),'k.','markersize',8)
line([.3 2.11], [0 0],'color',[.7 .7 .7],'linestyle',':')
tp_editplots; xlabel('Frequency [Hz]');ylabel('Mean corr.')
set(gca,'xtick',log10(freqoi(1:4:25)),'xticklabel',round(freqoi(1:4:25)))
axis([.3 2.11 -0.05 0.05]); title(sprintf('SOM: r = %.3f',r_M1_lr))

print(gcf,'-dpdf',sprintf('~/pp/plots/pp_src_ROIs_v%d.pdf',v))

%% PLOT NAI / POWER
addpath ~/Documents/MATLAB/Colormaps/'Colormaps (5)'/Colormaps/
addpath /home/gnolte/meth/highlevel/
addpath ~/Documents/MATLAB/cbrewer/cbrewer/
% figure_w;
% 
% subplot(1,2,1);
% 
% imagesc(nanmean(nai_ham_BNA,3)./max(max(nanmean(nai_ham_BNA,3))),[0 .3])
% colormap(inferno)
% 
% subplot(1,2,2);
% 
% imagesc(nanmean(nai_gla_BNA,3)./max(max(nanmean(nai_gla_BNA,3))),[0 .3])
% colormap(inferno)
% 
cmap = cbrewer('div', 'RdBu', 256,'pchip'); cmap = cmap(end:-1:1,:);

for ifoi = 22
% ifoi = 14;

[h,p] = ttest(plt_all.corr_src(:,ifoi,:),zeros(size(plt_all.corr_src(:,ifoi,:))),'dim',3);
h=p<(fdr1(p(:),0.05,0));
par=nanmean(plt_all.corr_src(:,ifoi,:),3).*h;
% par = par.*(p<fdr1(p,0.05));

% par=nanmean(all_corr(:,ifoi,isubj),3)./max(nanmean(all_corr(:,ifoi,isubj),3)); 
clim = [-max([abs([min(par(:)) max(par(:))])]) max([abs([min(par(:)) max(par(:))])])];
% clim = [min(par) max(par)]
% clim = [- 0.075 0.075]
para = [];
para.colorlimits = clim
para.colormaps{1} = cmap;
para.orientation = 'axial';

para.dslice_shown = 0.75;
para.colorbar= 0;

tp_showmri_transp(mri,para,[BNA.grid_5mm./10 par])
print(gcf,'-dpdf',sprintf('~/pp/plots/pp_src_corr_sourcemap_avg_f%d_v%d.tiff',ifoi,v))

% close

end
%%
% 123, 321, 132, 312, 213, 231

BNA.grid_5mm=sa.grid_BNA_5mm;

ifoi = 10;
isubj=1:22;
par=nanmean(plt_gla.nai_src(:,ifoi,isubj),3);
% par=rand(8799,1);

[i,j]=sort(par);

cmap = inferno(max(j));
figure_w;

for i = 1 :8799
  i
%   idx=find(j==i);
  plot3(BNA.grid_5mm(j(i),1)/10,BNA.grid_5mm(j(i),2)/10,BNA.grid_5mm(j(i),3)/10,'.','color',cmap(i,:))
  
  hold on
end
axis off

%% COMPARE DISTRIBUTION OF DATA GLA-HH
figure_w;
kk=0;
for ifreq = 1 : 2 : 23
  kk=kk+1;
  subplot(4,3,kk)
  [k,n]=hist(nanmean(plt_gla.nai_src(:,ifreq,:),3),100);
  
  plot(zscore(n),k,'k-'); hold on
  
  [k,n]=hist(nanmean(plt_hh.nai_src(:,ifreq,:),3),100);
  plot(zscore(n),k,'k--')
  
  [k,n]=hist(nanmean(rand(8799,1,20),3),100);
  plot(zscore(n),k,':','color',[.6 .6 .6])
  
  title(sprintf('Freq = %d Hz',round(freqoi(ifreq))))
end

%% PLOT CROSS FREQUENCY
clear src_r_all
cmap = cbrewer('div', 'RdBu', 256,'pchip'); cmap = cmap(end:-1:1,:);
v=1
subj_idx=[];
for isubj = SUBJLIST
  isubj
  for iblock = 1 : 2
    clear src_r
    try
      load(sprintf([outdir 'pp_src_pupil_power_correlations_crossfreq_s%d_b%d_v%d.mat'],isubj,iblock,v));
      subj_idx=[subj_idx isubj];
      src_r_all(:,:,:,isubj,iblock)=src_r;
    catch me
      src_r_all(:,:,:,isubj,iblock)=nan(8799,25,21);
    end
  end
end

subj_idx = unique(subj_idx);
src_r_all=nanmean(src_r_all(:,:,:,subj_idx,:),5);


for igrid = 1 : max(BNA.tissue_5mm(:))
  src_r_BNA(igrid,:,:,:) = mean(src_r_all(BNA.tissue_5mm == igrid,:,:,:));
end
    %%
par=nanmean(src_r_all(:,10,4,:),4);

% par=nanmean(all_corr(:,ifoi,isubj),3)./max(nanmean(all_corr(:,ifoi,isubj),3));
clim = [-max([abs([min(par(:)) max(par(:))])]) max([abs([min(par(:)) max(par(:))])])];

para = [];
para.colorlimits = clim
para.colormaps{1} = cmap;
para.orientation = 'axial';
para.dslice_shown = 0.75;
para.colorbar= 0;

tp_showmri_transp(mri,para,[BNA.grid_5mm./10 par])
% print(gcf,'-dpdf',sprintf('~/pp/plots/pp_src_corr_sourcemap_crossfreq_f%d_v%d.pdf',ifoi,v))



